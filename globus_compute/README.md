# Globus Compute Instructions

## Checkers setup

### Setting up local Python environment
1. Create a local Python environment by running `python3 -m venv myenv`, where `myenv` is the name of your environment.
2. Activate the environment by running `source myenv/bin/activate`.
3. If you ever need to deactivate the environment, simply run `deactivate`.

### Installing Globus
1. Install the Globus Compute SDK by running `python3 -m pip install globus-compute-sdk`
2. If you don't have access to a Globus Compute Client Id and Secret, you will need to generate them before proceeding.
3. Navigate to the directory where you want all of your Globus files. Create a new file called `globus-authenticate.sh` and add the following lines:
    ```
    export GLOBUS_COMPUTE_CLIENT_ID="<your client id>"
    export GLOBUS_COMPUTE_CLIENT_SECRET="<your secret>"
    ```
    Now every time you start a new session, before you run a globus command you need to run `source globus-authenticate.sh`

### Using Globus
1. See `gem_globus_script.py` for a template of how to send functions to Globus. 
2. In order for Globus to connect to your endpoint, you must set the endpoint id as an environment variable. For example, in `gem_globus_script.py` the Anvil endpoint must be set as `ANVIL_ENDPOINT_ID`.

## Endpoint setup
1. Create a new directory called `globus_compute` on the system where you want to install the endpoint (for example, Anvil).
2. As with Checkers, you must create the `globus-authenticate.sh` file with your Globus credentials.
3. Install the Globus Compute Endpoint by running `python3 -m pip install globus-compute-endpoint`.
4. Configure the default endpoint by running `globus-compute-endpoint configure`.
5. Start the endpoint by running `globus-compute-endpoint start`.
6. You can view the status of your endpoint at any time by running `globus-compute-endpoint list`. This will also tell you the id of the endpoint.
7. To ensure the endpoint stays running, copy the `restart.sh` file into your `globus_compute` directory. Depending on what system you are using, you may need to modify this file. This script restarts the endpoint, then requeues itself to run again every 24 hours.

## Gem Reconnection

### Directory setup
The scripts currently depend on the directory setup, so here is how your directories are expected to be configured on the endpoint machine:
- The home directory contains 3 subdirectories: `globus_compute` as mentioned above, `vlabApps`, and `slurm_jobs`.
    - `vlabApps` is a clone of the Github repo.
    - `slurm_jobs` contains `gem_slurm.sh`, the Slurm script which runs the `gem_reconnection.sh` file from the `vlabApps` repo.

### Running gem_reconnection
- To run gem reconnection directly on the endpoint machine, you can simply run `sbatch gem_slurm.sh`.
- To run gem reconnection from Checkers, run the Python script via `python3 gem_globus_script.py`.
- After running gem reconnection, the files generated by `gem_reconnection.sh` will appear in `slurm_jobs/gem_job_files`. Additionally, the stdout and stderr will appear in `slurm_jobs/gem.out` and `slurm_jobs/gem.err` respectively. If it was run from Checkers, the stdout and stderr will also appear in `gem_job.out` and `gem_job.err` in the same directory as the Python script.
